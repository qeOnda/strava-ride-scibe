"use strict";var s=Object.defineProperty;var b=Object.getOwnPropertyDescriptor;var A=Object.getOwnPropertyNames;var g=Object.prototype.hasOwnProperty;var C=(e,t)=>{for(var o in t)s(e,o,{get:t[o],enumerable:!0})},N=(e,t,o,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of A(t))!g.call(e,n)&&n!==o&&s(e,n,{get:()=>t[n],enumerable:!(r=b(t,n))||r.enumerable});return e};var P=e=>N(s({},"__esModule",{value:!0}),e);var k={};C(k,{handler:()=>_});module.exports=P(k);var l=require("@aws-sdk/client-dynamodb"),p=require("@aws-sdk/lib-dynamodb"),O=require("@aws-sdk/client-sqs");var y=require("@aws-sdk/lib-dynamodb"),E=require("api-helper"),a=require("encryption"),u=process.env.SECRE_KEY_HEX||"",T=process.env.TABLE_NAME||"",d=async({dynamodbClient:e,event:t})=>{let o=t.queryStringParameters?.code||"";if(o){console.log(`## EXCHANGING CODE ${o} FOR ACCESS TOKENS`);try{let r=await(0,E.authorizeStravaOAuth)(o),n=(0,a.encrypt)({text:r.access_token.toString(),key:Buffer.from(u,"hex")}),i=(0,a.encrypt)({text:r.refresh_token.toString(),key:Buffer.from(u,"hex")}),c=r.expires_at.toString();return await e.put({TableName:T,Item:{UserId:y.NumberValue.from(r.athlete.id),SK:"METADATA",AccessToken:n,RefreshToken:i,ExpiresAt:c}}),{statusCode:200,body:JSON.stringify({message:"OAuth authentication successful"})}}catch(r){return console.error("## ERROR EXCHANGING CODE FOR TOKENS:",r),{statusCode:500,body:JSON.stringify({error:"Internal server error"})}}}return{statusCode:400,body:JSON.stringify({error:"Missing authorization code"})}};var S=require("@aws-sdk/client-sqs"),m=process.env.SQS_QUEUE_URL||"",h=async({sqsClient:e,event:t})=>{if(!t.body)return{statusCode:400,body:JSON.stringify({error:"Bad request: missing body"})};let o=JSON.parse(t.body);if(console.log("## WEBHOOK BODY:",JSON.stringify(o,null,2)),o){if(o.aspect_type==="create"&&o.object_type==="activity")try{console.log("## SENDING MESSAGE TO SQS QUEUE:",m);let r=new S.SendMessageCommand({QueueUrl:m,DelaySeconds:10,MessageBody:JSON.stringify(o)}),n=await e.send(r);console.log("## MESSAGE SUCCESSFULLY SENT. MESSAGE_ID:",n.MessageId)}catch(r){return console.error("## WEBHOOK EVENT ERROR:",r),{statusCode:500,body:JSON.stringify({error:"Failed to process event"})}}return{statusCode:200}}return{statusCode:400,body:JSON.stringify({error:"Bad request"})}};var x=process.env.VERIFY_TOKEN,f=e=>{let t=e.queryStringParameters??{},o=t["hub.mode"]??"",r=t["hub.verify_token"]??"",n=t["hub.challenge"]??"";if(o&&r)return o==="subscribe"&&r===x?{statusCode:200,body:JSON.stringify({"hub.challenge":n})}:{statusCode:403}};var D=new O.SQSClient({}),I=p.DynamoDBDocument.from(new l.DynamoDB({})),_=async e=>(console.log("## EVENT RECEIVED: ",JSON.stringify(e)),e.resource==="/webhook"&&e.httpMethod==="POST"?await h({sqsClient:D,event:e}):e.resource==="/webhook"&&e.httpMethod==="GET"?f(e):e.resource==="/oauth-authentication"&&e.httpMethod==="POST"?await d({dynamodbClient:I,event:e}):{statusCode:400,body:JSON.stringify({error:"Bad request"})});0&&(module.exports={handler});
